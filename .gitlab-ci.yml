before_script:
- git submodule init
- git submodule update

variables:
  # flaw-social, flaw-websocket-server removed from PACKAGES_LINUX
  # they depend on wai-routes which's not in GHC8 snapshot yet
  PACKAGES_LINUX: >-
    flaw-al
    flaw-app
    flaw-asset
    flaw-asset-dxt
    flaw-asset-wai
    flaw-audio
    flaw-base
    flaw-build
    flaw-bullet
    flaw-canvas
    flaw-collada
    flaw-editor
    flaw-ffi
    flaw-ffmpeg
    flaw-font
    flaw-font-fthb
    flaw-game
    flaw-gl
    flaw-gl-mesa
    flaw-gl-sdl
    flaw-graphics
    flaw-input
    flaw-lua
    flaw-lua-refimpl
    flaw-math
    flaw-network
    flaw-oil
    flaw-oil-client
    flaw-oil-entity
    flaw-oil-server
    flaw-physics
    flaw-sdl
    flaw-sl
    flaw-sqlite
    flaw-ui
    flaw-ui-default-style
    flaw-visual
    flaw-window
  PACKAGES_WINDOWS: >-
    flaw-al
    flaw-app
    flaw-asset
    flaw-asset-dxt
    flaw-audio
    flaw-base
    flaw-build
    flaw-bullet
    flaw-canvas
    flaw-collada
    flaw-dx11
    flaw-editor
    flaw-ffi
    flaw-font
    flaw-font-fthb
    flaw-game
    flaw-gl
    flaw-gl-win32
    flaw-graphics
    flaw-input
    flaw-lua
    flaw-lua-refimpl
    flaw-math
    flaw-network
    flaw-oil
    flaw-oil-client
    flaw-oil-entity
    flaw-physics
    flaw-sl
    flaw-sqlite
    flaw-ui
    flaw-ui-default-style
    flaw-visual
    flaw-window
  PACKAGES_OSX: >-
    flaw-al
    flaw-app
    flaw-asset
    flaw-asset-dxt
    flaw-audio
    flaw-base
    flaw-build
    flaw-bullet
    flaw-canvas
    flaw-collada
    flaw-editor
    flaw-ffi
    flaw-ffmpeg
    flaw-font
    flaw-font-fthb
    flaw-game
    flaw-gl
    flaw-gl-sdl
    flaw-graphics
    flaw-input
    flaw-lua
    flaw-lua-refimpl
    flaw-math
    flaw-network
    flaw-oil
    flaw-oil-client
    flaw-oil-entity
    flaw-physics
    flaw-sdl
    flaw-sl
    flaw-sqlite
    flaw-ui
    flaw-ui-default-style
    flaw-visual
    flaw-window
  PACKAGES_WEB: >-
    flaw-app
    flaw-asset
    flaw-audio
    flaw-base
    flaw-build
    flaw-canvas
    flaw-ffi
    flaw-game
    flaw-gl
    flaw-graphics
    flaw-input
    flaw-js
    flaw-math
    flaw-network
    flaw-physics
    flaw-sl
    flaw-social
    flaw-websocket-client
    flaw-window
  INTEGERSIMPLE_FLAGS_WINDOWS: >-
    --ghc-variant integersimple
    --flag text:integer-simple
    --flag hashable:-integer-gmp
    --flag cryptonite:-integer-gmp
    --flag scientific:integer-simple
  FIX_TH_WINDOWS: >-
    powershell
    "Add-Content flaw-font-fthb\flaw-font-fthb.cabal \"  extra-ghci-libraries: all\""

linux:
  script:
  - "mkdir -p flaw-linux/bin"
  - "stack --no-terminal build --test --copy-bins --local-bin-path flaw-linux/bin $PACKAGES_LINUX"
  artifacts:
    name: "flaw-linux_x64-$CI_BUILD_ID"
    paths:
    - flaw-linux
  tags:
  - haskellstack
  - linux
  - x64
  except:
  - arm

windows:
  script:
  - "%FIX_TH_WINDOWS%"
  - "mkdir flaw-windows\\bin"
  - "stack --no-terminal build --test --copy-bins --local-bin-path flaw-windows/bin %INTEGERSIMPLE_FLAGS_WINDOWS% %PACKAGES_WINDOWS%"
  artifacts:
    name: "flaw-windows_x64-$CI_BUILD_ID"
    paths:
    - flaw-windows
  tags:
  - haskellstack
  - windows
  - x64
  except:
  - arm

osx:
  script:
  - "mkdir -p flaw-osx/bin"
  - "stack --no-terminal build --test --copy-bins --local-bin-path flaw-osx/bin $PACKAGES_OSX"
  artifacts:
    name: "flaw-osx_x64-$CI_BUILD_ID"
    paths:
    - flaw-osx
  tags:
  - haskellstack
  - osx
  - x64
  except:
  - arm

# temporary disabled because of ghcjs' brokeness
.web:
  script:
  - "stack --no-terminal --compiler ghcjs-0.2.0_ghc-7.10.3 build --test $PACKAGES_WEB"
  tags:
  - haskellstack
  - ghcjs
  - linux
  - x64
  except:
  - arm

linux-arm:
  script:
  - "mkdir -p flaw-linux-arm/bin"
  - "stack --no-terminal build --test --copy-bins --local-bin-path flaw-linux-arm/bin $PACKAGES_LINUX"
  artifacts:
    name: "flaw-linux_arm-$CI_BUILD_ID"
    paths:
    - flaw-linux-arm
  tags:
  - haskellstack
  - linux
  - arm
  only:
  - arm

itch:
  stage: deploy
  environment: itch
  dependencies:
  - linux
  - windows
  - osx
  script:
  - "mkdir linux && mv flaw-linux/bin/model-editor linux/"
  - "mkdir windows && mv flaw-windows/bin/model-editor.exe windows/"
  - "mkdir osx && mv flaw-osx/bin/model-editor osx/"
  - "butler push linux quyse/flaw:model-editor-linux"
  - "butler push windows quyse/flaw:model-editor-windows"
  - "butler push osx quyse/flaw:model-editor-osx"
  tags:
  - linux
  - butler
  only:
  - master

pages:
  stage: deploy
  environment: pages
  dependencies: []
  script:
  - "stack --no-terminal build --test --haddock --coverage $PACKAGES_LINUX"
  - "mkdir public"
  - "hlint . --cross --no-exit-code --quiet --report=public/hlint.html"
  - "mv $(stack path --local-doc-root) public/docs"
  - "mv $(stack path --local-hpc-root) public/hpc"
  - "./pages/sanitize.sh public"
  - "curl -o public/docs/badge.svg https://img.shields.io/badge/haddock-$(date +%Y/%m/%d)-blue.svg"
  - "curl -o public/hpc/badge.svg https://img.shields.io/badge/test%20coverage-$(date +%Y/%m/%d)-orange.svg"
  tags:
  - haskellstack
  - linux
  - x64
  artifacts:
    paths:
    - public
  only:
  - master
